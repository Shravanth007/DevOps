name: deploy-to-k8s

on:
  workflow_run:
    workflows: ["CI Pipeline - Continuous Integration"]
    types: [completed]
    branches: [master, main]
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/devops-demo-app

jobs:
  deploy-to-k8s:
    name: deploy-to-k8s
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Verify Cluster Connection
        shell: powershell
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Update Deployment Image
        shell: powershell
        run: |
          (Get-Content k8s/deployment.yaml) -replace 'IMAGE_PLACEHOLDER', '${{ env.DOCKER_IMAGE_NAME }}:latest' | Set-Content k8s/deployment.yaml

      - name: Deploy to Kubernetes
        shell: powershell
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      - name: Wait for Deployment Rollout
        shell: powershell
        run: |
          kubectl rollout status deployment/devops-demo-app -n devops-demo --timeout=5m
          kubectl get pods -n devops-demo
          kubectl get svc -n devops-demo

      # ---- Port forward (single stable version) ----
      - name: Start Port Forward
        shell: powershell
        run: |
          Write-Host "Starting port-forward on 8080..."
          Start-Process -NoNewWindow -FilePath "kubectl" -ArgumentList "port-forward svc/devops-demo-service 8080:8080 -n devops-demo" 
          Start-Sleep -Seconds 10
          netstat -ano | findstr :8080

      - name: Smoke Test - Health
        shell: powershell
        run: |
          $maxAttempts = 10
          for ($i = 1; $i -le $maxAttempts; $i++) {
            try {
              $r = Invoke-WebRequest -Uri "http://localhost:8080/api/health" -UseBasicParsing -TimeoutSec 5
              Write-Host "✅ HEALTH OK"
              Write-Host $r.Content
              exit 0
            } catch {
              Write-Host "Waiting for app... attempt $i/$maxAttempts"
              Start-Sleep -Seconds 6
            }
          }
          Write-Host "❌ Health check failed"
          exit 1

      - name: Smoke Test - Version
        shell: powershell
        run: |
          $r = Invoke-WebRequest -Uri "http://localhost:8080/api/version" -UseBasicParsing
          Write-Host "✅ VERSION OK"
          Write-Host $r.Content

      - name: Smoke Test - Actuator
        shell: powershell
        run: |
          $r = Invoke-WebRequest -Uri "http://localhost:8080/actuator/health" -UseBasicParsing
          Write-Host "✅ ACTUATOR OK"
          Write-Host $r.Content

  