name: deploy-to-k8s

on:
  workflow_run:
    workflows: ["CI Pipeline - Continuous Integration"]
    types: [completed]
    branches: [master, main]
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/devops-demo-app

jobs:
  deploy-to-k8s:
    name: deploy-to-k8s
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Start Minikube
        shell: powershell
        run: |
          Write-Host "Checking Minikube status..."
          minikube status

          Write-Host "Starting Minikube..."
          minikube start --driver=docker

          Write-Host "Minikube started successfully"
          minikube status

      - name: Verify Cluster Connection
        shell: powershell
        run: |
          Write-Host "Verifying Kubernetes cluster..."
          kubectl config current-context
          kubectl get nodes
          kubectl cluster-info

      - name: Update Deployment Image
        shell: powershell
        run: |
          Write-Host "Updating image in deployment.yaml"
          (Get-Content k8s/deployment.yaml) -replace 'IMAGE_PLACEHOLDER', '${{ env.DOCKER_IMAGE_NAME }}:latest' | Set-Content k8s/deployment.yaml
          Write-Host "Updated deployment image successfully"

      - name: Deploy to Kubernetes
        shell: powershell
        run: |
          Write-Host "Applying Kubernetes manifests..."
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      - name: Wait for Deployment Rollout
        shell: powershell
        run: |
          Write-Host "Waiting for rollout..."
          kubectl rollout status deployment/devops-demo-app -n devops-demo --timeout=5m

          Write-Host "Pods:"
          kubectl get pods -n devops-demo -o wide

          Write-Host "Services:"
          kubectl get svc -n devops-demo -o wide

      - name: Smoke Tests (Kubernetes)
        shell: powershell
        run: |
          Write-Host "Running smoke tests..."
          Write-Host "Using port-forward on localhost:18080"

          $pf = Start-Process -PassThru -NoNewWindow -FilePath "kubectl" -ArgumentList "port-forward svc/devops-demo-service 18080:8080 -n devops-demo"

          Start-Sleep -Seconds 10

          try {
            $maxAttempts = 15
            for ($i = 1; $i -le $maxAttempts; $i++) {
              try {
                $r = Invoke-WebRequest -Uri "http://localhost:18080/api/health" -UseBasicParsing -TimeoutSec 10
                Write-Host "Health OK"
                Write-Host $r.Content
                break
              } catch {
                Write-Host "Waiting for app... attempt $i/$maxAttempts"
                Start-Sleep -Seconds 4
                if ($i -eq $maxAttempts) { throw "Health check failed after retries" }
              }
            }

            $v = Invoke-WebRequest -Uri "http://localhost:18080/api/version" -UseBasicParsing -TimeoutSec 10
            Write-Host "Version OK"
            Write-Host $v.Content

            $a = Invoke-WebRequest -Uri "http://localhost:18080/actuator/health" -UseBasicParsing -TimeoutSec 10
            Write-Host "Actuator OK"
            Write-Host $a.Content

            Write-Host "All smoke tests PASSED"
          }
          finally {
            if ($pf -and $pf.Id) {
              Stop-Process -Id $pf.Id -Force -ErrorAction SilentlyContinue
              Write-Host "Port-forward stopped"
            }
          }

      - name: Deployment Summary
        shell: powershell
        if: always()
        run: |
          "## Deployment Summary" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "- Workflow: deploy-to-k8s" >> $env:GITHUB_STEP_SUMMARY
          "- Cluster: minikube" >> $env:GITHUB_STEP_SUMMARY
          "- Image: ${{ env.DOCKER_IMAGE_NAME }}:latest" >> $env:GITHUB_STEP_SUMMARY
          "- SHA: ${{ github.sha }}" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "Namespace: devops-demo" >> $env:GITHUB_STEP_SUMMARY
