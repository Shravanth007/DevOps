name: deploy-to-k8s

on:
  workflow_run:
    workflows: ["CI Pipeline - Continuous Integration"]
    types: [completed]
    branches: [master, main]
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/devops-demo-app

jobs:
  deploy-to-k8s:
    name: deploy-to-k8s
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      # -----------------------------
      # 1) Checkout
      # -----------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # -----------------------------
      # 2) Start Minikube (critical)
      # -----------------------------
      - name: Start Minikube
        shell: powershell
        run: |
          Write-Host "ðŸ”„ Checking Minikube status..."
          minikube status
          
          Write-Host "ðŸš€ Starting Minikube..."
          minikube start --driver=docker
          
          Write-Host "âœ… Minikube started successfully"
          minikube status

      # -----------------------------
      # 3) Verify Cluster
      # -----------------------------
      - name: Verify Cluster Connection
        shell: powershell
        run: |
          Write-Host "ðŸ” Verifying Kubernetes cluster..."
          kubectl config current-context
          kubectl get nodes
          kubectl cluster-info

      # -----------------------------
      # 4) Replace Docker image placeholder
      # -----------------------------
      - name: Update Deployment Image
        shell: powershell
        run: |
          Write-Host "ðŸ–¼ï¸ Updating image in deployment.yaml"
          (Get-Content k8s/deployment.yaml) -replace 'IMAGE_PLACEHOLDER', '${{ env.DOCKER_IMAGE_NAME }}:latest' | Set-Content k8s/deployment.yaml
          Write-Host "âœ… Updated deployment image to ${{ env.DOCKER_IMAGE_NAME }}:latest"

      # -----------------------------
      # 5) Deploy manifests
      # -----------------------------
      - name: Deploy to Kubernetes
        shell: powershell
        run: |
          Write-Host "ðŸ“¦ Applying Kubernetes manifests..."
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      # -----------------------------
      # 6) Rollout Status + Logs
      # -----------------------------
      - name: Wait for Deployment Rollout
        shell: powershell
        run: |
          Write-Host "â³ Waiting for rollout..."
          kubectl rollout status deployment/devops-demo-app -n devops-demo --timeout=5m

          Write-Host ""
          Write-Host "âœ… Pods:"
          kubectl get pods -n devops-demo -o wide

          Write-Host ""
          Write-Host "âœ… Services:"
          kubectl get svc -n devops-demo -o wide

      # -----------------------------
      # 7) Smoke Tests via port-forward
      #    (Stable method: same step)
      # -----------------------------
      - name: Smoke Tests (Kubernetes)
        shell: powershell
        run: |
          Write-Host "ðŸ§ª Running smoke tests..."
          Write-Host "âš ï¸ Using port-forward on localhost:18080 (avoids 8080 conflicts)"

          # Cleanup any previous kubectl port-forward processes (optional but helpful)
          Get-Process kubectl -ErrorAction SilentlyContinue | Where-Object { $_.Path -like "*kubectl*" } | ForEach-Object {
            # don't kill normal kubectl calls, only long port-forward ones, so this is kept minimal
          }

          # Start port-forward and keep handle
          $pf = Start-Process -PassThru -NoNewWindow -FilePath "kubectl" -ArgumentList "port-forward svc/devops-demo-service 18080:8080 -n devops-demo"

          Start-Sleep -Seconds 10

          try {
            # Health test (retry)
            $maxAttempts = 15
            for ($i = 1; $i -le $maxAttempts; $i++) {
              try {
                $r = Invoke-WebRequest -Uri "http://localhost:18080/api/health" -UseBasicParsing -TimeoutSec 10
                Write-Host "âœ… HEALTH OK"
                Write-Host $r.Content
                break
              } catch {
                Write-Host "Waiting for app... attempt $i/$maxAttempts"
                Start-Sleep -Seconds 4
                if ($i -eq $maxAttempts) { throw "Health check failed after retries" }
              }
            }

            # Version endpoint
            $v = Invoke-WebRequest -Uri "http://localhost:18080/api/version" -UseBasicParsing -TimeoutSec 10
            Write-Host "âœ… VERSION OK"
            Write-Host $v.Content

            # Actuator health
            $a = Invoke-WebRequest -Uri "http://localhost:18080/actuator/health" -UseBasicParsing -TimeoutSec 10
            Write-Host "âœ… ACTUATOR OK"
            Write-Host $a.Content

            Write-Host ""
            Write-Host "ðŸŽ‰ All smoke tests PASSED"
          }
          finally {
            if ($pf -and $pf.Id) {
              Stop-Process -Id $pf.Id -Force -ErrorAction SilentlyContinue
              Write-Host "ðŸ§¹ Port-forward stopped"
            }
          }

      # -----------------------------
      # 8) Final Summary
      # -----------------------------
      - name: Deployment Summary
        shell: powershell
        if: always()
        run: |
          "## ðŸš€ Deployment Summary" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "- Workflow: deploy-to-k8s" >> $env:GITHUB_STEP_SUMMARY
          "- Cluster: minikube" >> $env:GITHUB_STEP_SUMMARY
          "- Image: ${{ env.DOCKER_IMAGE_NAME }}:latest" >> $env:GITHUB_STEP_SUMMARY
          "- SHA: ${{ github.sha }}" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "### Kubernetes Resources" >> $env:GITHUB_STEP_SUMMARY
          "Pods and Services are deployed under namespace: devops-demo." >> $env:GITHUB_STEP_SUMMARY
