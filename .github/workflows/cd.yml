name: CD Pipeline - Continuous Deployment

# Trigger Configuration
on:
  workflow_run:
    workflows: ["CI Pipeline - Continuous Integration"]
    types:
      - completed
    branches: [master, main]
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/devops-demo-app
  KUBECONFIG_DATA: ${{ secrets.KUBECONFIG }}

jobs:
  # Job 1: Deploy to Kubernetes
  deploy-kubernetes:
    name: Deploy to Kubernetes
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Verify Cluster Connection
        shell: powershell
        run: |
          kubectl cluster-info
          kubectl get nodes
      
      - name: Update Deployment Image
        shell: powershell
        run: |
          (Get-Content k8s/deployment.yaml) -replace 'IMAGE_PLACEHOLDER', '${{ env.DOCKER_IMAGE_NAME }}:latest' | Set-Content k8s/deployment.yaml
      
      - name: Deploy to Kubernetes
        shell: powershell
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
      
      - name: Wait for Deployment Rollout
        shell: powershell
        run: |
          kubectl rollout status deployment/devops-demo-app -n devops-demo --timeout=5m
      
      - name: Verify Deployment
        shell: powershell
        run: |
          kubectl get pods -n devops-demo
          kubectl get services -n devops-demo
      
      - name: Get Service URL
        shell: powershell
        run: |
          Write-Host "Application deployed successfully!"
          kubectl get service devops-demo-service -n devops-demo
  
  # Job 2: DAST - Dynamic Application Security Testing
  dast-scan:
    name: DAST Security Scan
    runs-on: self-hosted
    needs: [deploy-kubernetes]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Wait for Application Startup
        shell: powershell
        run: Start-Sleep -Seconds 60
      
      - name: Get Application URL
        id: get-url
        shell: powershell
        run: |
          # Get the Minikube service URL
          $serviceUrl = minikube service devops-demo-service -n devops-demo --url
          "APP_URL=$serviceUrl" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
      
      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: ${{ steps.get-url.outputs.APP_URL }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          fail_action: false
      
      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-scan-report
          path: report_html.html
  
  # Job 3: Smoke Tests
  smoke-tests:
    name: Post-Deployment Smoke Tests
    runs-on: self-hosted
    needs: [deploy-kubernetes]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Port Forward to Service
        shell: powershell
        run: |
          Start-Job -ScriptBlock { kubectl port-forward service/devops-demo-service 8080:8080 -n devops-demo }
          Start-Sleep -Seconds 10
      
      - name: Test Health Endpoint
        shell: powershell
        run: |
          $maxAttempts = 5
          for ($i = 1; $i -le $maxAttempts; $i++) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:8080/api/health" -UseBasicParsing
              if ($response.StatusCode -eq 200) {
                Write-Host "âœ… Health check passed!"
                exit 0
              }
            } catch {
              Write-Host "Attempt $i failed, retrying..."
              Start-Sleep -Seconds 5
            }
          }
          exit 1
      
      - name: Test Version Endpoint
        shell: powershell
        run: |
          $response = Invoke-WebRequest -Uri "http://localhost:8080/api/version" -UseBasicParsing
          Write-Host "âœ… Version endpoint working!"
          Write-Host $response.Content
      
      - name: Test Actuator Health
        shell: powershell
        run: |
          $response = Invoke-WebRequest -Uri "http://localhost:8080/actuator/health" -UseBasicParsing
          Write-Host "âœ… Actuator health check passed!"
          Write-Host $response.Content
  
  # Job 4: Deployment Summary
  deployment-summary:
    name: Deployment Summary
    runs-on: self-hosted
    needs: [deploy-kubernetes, dast-scan, smoke-tests]
    if: always()
    
    steps:
      - name: Generate Deployment Report
        run: |
          echo "# ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Kubernetes Deployment: ${{ needs.deploy-kubernetes.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… DAST Scan: ${{ needs.dast-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Smoke Tests: ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Image Information" >> $GITHUB_STEP_SUMMARY
          echo "- Image: ${{ env.DOCKER_IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "- SHA: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
