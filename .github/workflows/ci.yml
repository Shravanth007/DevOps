name: CI Pipeline - Continuous Integration

# Trigger Configuration
on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

# Global permissions
permissions:
  contents: read
  security-events: write
  actions: read

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: -Xmx1024m
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/devops-demo-app

jobs:
  # Job 1: Code Quality & Linting
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Run Checkstyle
        run: mvn checkstyle:check
        continue-on-error: true
      
      - name: Upload Checkstyle Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: checkstyle-report
          path: target/checkstyle-result.xml
  
  # Job 2: SAST - Static Application Security Testing
  sast-codeql:
    name: CodeQL Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: java
          queries: security-and-quality
      
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Build with Maven
        run: mvn clean compile -DskipTests
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:java"
  
  # Job 3: SCA - Software Composition Analysis
  dependency-check:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Run OWASP Dependency Check
        run: mvn dependency-check:check
        continue-on-error: true
      
      - name: Upload Dependency Check Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-report
          path: target/dependency-check-report.html
  
  # Job 4: Unit Tests & Code Coverage
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [code-quality]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Run Tests with Coverage
        run: mvn clean test jacoco:report
      
      - name: Generate Coverage Report
        run: mvn jacoco:report
      
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/site/jacoco/
      
      - name: Check Test Results
        if: failure()
        run: echo "Tests failed! Check the logs above."
  
  # Job 5: Build Application
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [test, dependency-check]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Build JAR
        run: mvn clean package -DskipTests
      
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/*.jar
  
  # Job 6: Docker Build & Security Scan
  docker-build-scan:
    name: Docker Build & Image Scan
    runs-on: ubuntu-latest
    needs: [build]
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker Image
        run: |
          docker build -t ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} .
          docker tag ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} ${{ env.DOCKER_IMAGE_NAME }}:latest
      
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Run Trivy (Table Format)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          format: 'table'
          exit-code: '0'
      
      - name: Save Docker Image
        run: docker save ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} -o devops-demo-app.tar
      
      - name: Upload Docker Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: devops-demo-app.tar
  
  # Job 7: Container Runtime Test
  container-test:
    name: Container Runtime Validation
    runs-on: ubuntu-latest
    needs: [docker-build-scan]
    
    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
      
      - name: Load Docker Image
        run: docker load -i devops-demo-app.tar
      
      - name: Run Container
        run: |
          docker run -d -p 8080:8080 --name test-container ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          sleep 30
      
      - name: Test Health Endpoint
        run: |
          curl -f http://localhost:8080/api/health || exit 1
          echo "Health check passed!"
      
      - name: Test Version Endpoint
        run: |
          curl -f http://localhost:8080/api/version || exit 1
          echo "Version endpoint check passed!"
      
      - name: Check Container Logs
        if: always()
        run: docker logs test-container
      
      - name: Stop Container
        if: always()
        run: docker stop test-container && docker rm test-container
  
  # Job 8: Push to DockerHub
  docker-push:
    name: Push to DockerHub
    runs-on: ubuntu-latest
    needs: [container-test]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
      
      - name: Load Docker Image
        run: docker load -i devops-demo-app.tar
      
      - name: Tag Docker Image as Latest
        run: docker tag ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} ${{ env.DOCKER_IMAGE_NAME }}:latest
      
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Push Docker Image
        run: |
          docker push ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.DOCKER_IMAGE_NAME }}:latest
      
      - name: Image Pushed Successfully
        run: |
          echo "âœ… Docker image pushed successfully!"
          echo "Image: ${{ env.DOCKER_IMAGE_NAME }}:latest"
          echo "SHA: ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}"
